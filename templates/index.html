<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <title>–ß–∞—Ç–±–æ—Ç - –û–±—â–∏–Ω–∞ –î–∏–º–∏—Ç—Ä–æ–≤–≥—Ä–∞–¥</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f2f2f2;
            margin: 0;
            padding: 0;
        }
        #chatbox {
            width: 100%;
            max-width: 800px;
            margin: 30px auto;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: 80vh;
            position: relative;
        }
        #langToggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #1976D2;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 5px 10px;
            cursor: pointer;
        }
        #chat {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            margin-top: 40px; /* –∑–∞ –¥–∞ –Ω–µ —Å–µ –∑–∞—Å—Ç—ä–ø–≤–∞ —Å –±—É—Ç–æ–Ω–∞ */
        }
        .message {
            margin: 10px 0;
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 70%;
            line-height: 1.4em;
        }
        .message.user {
            background: #dcf8c6;
            align-self: flex-end;
        }
        .message.bot {
            background: #f1f0f0;
            align-self: flex-start;
        }
        #inputForm {
            display: flex;
            border-top: 1px solid #ccc;
            align-items: center;
        }
        #userInput {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 0 0 0 10px;
            font-size: 16px;
        }
        #inputForm button {
            padding: 15px;
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
        }
        #sendBtn { background: #4CAF50; border-radius: 0 0 10px 0; }
        #micBtn { background: #1976D2; }
        #speakBtn { background: #FF9800; }
        #inputForm button:disabled {
            background: #888;
            cursor: not-allowed;
        }
        #faqButtons {
            display: flex;
            flex-wrap: wrap;
            padding: 10px;
            gap: 10px;
            border-top: 1px solid #eee;
        }
        #faqButtons button {
            flex: 1;
            min-width: 180px;
            padding: 10px;
            border: none;
            background: #1976D2;
            color: white;
            border-radius: 8px;
            cursor: pointer;
        }
        #faqButtons button:hover {
            background: #125a9c;
        }
        #typing {
            font-style: italic;
            padding: 10px;
            display: none;
        }
        a {
            color: #1976D2;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div id="chatbox">
        <button id="langToggle">EN</button>
        <div id="chat"></div>
        <div id="typing">–ë–æ—Ç—ä—Ç –ø–∏—à–µ...</div>
        <form id="inputForm">
            <input type="text" id="userInput" placeholder="–í—ä–≤–µ–¥–µ—Ç–µ –≤—ä–ø—Ä–æ—Å..." autocomplete="off" required>
            <button type="button" id="micBtn">üé§</button>
            <button type="button" id="speakBtn">üîä</button>
            <button type="submit" id="sendBtn">–ò–∑–ø—Ä–∞—Ç–∏</button>
        </form>
        <div id="faqButtons"></div>
    </div>

    <script>
        const chat = document.getElementById('chat');
        const typing = document.getElementById('typing');
        const form = document.getElementById('inputForm');
        const input = document.getElementById('userInput');
        const micBtn = document.getElementById("micBtn");
        const speakBtn = document.getElementById("speakBtn");
        const langToggle = document.getElementById("langToggle");
        const faqButtonsContainer = document.getElementById("faqButtons");

        let lastBotReply = "";
        let currentLang = "bg";

        const faqData = {
            bg: [
                "–ö–æ–π –µ –∫–º–µ—Ç—ä—Ç –Ω–∞ –î–∏–º–∏—Ç—Ä–æ–≤–≥—Ä–∞–¥?",
                "–ö–æ–π –µ –ø—Ä–µ–¥—Å–µ–¥–∞—Ç–µ–ª –Ω–∞ –û–±—â–∏–Ω—Å–∫–∏—è —Å—ä–≤–µ—Ç?",
                "–†–∞–±–æ—Ç–Ω–æ –≤—Ä–µ–º–µ –Ω–∞ –æ–±—â–∏–Ω–∞—Ç–∞",
                "–¢–µ–ª–µ—Ñ–æ–Ω –∑–∞ –≤—Ä—ä–∑–∫–∞",
                "–ö—É–ª—Ç—É—Ä–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–∞",
                "–°–µ—Å–∏—è –Ω–∞ –û–±—â–∏–Ω—Å–∫–∏—è —Å—ä–≤–µ—Ç",
                "–ë—é–¥–∂–µ—Ç –Ω–∞ –æ–±—â–∏–Ω–∞—Ç–∞ –∑–∞ 2025",
                "–†–µ—à–µ–Ω–∏—è –Ω–∞ –û–±—â–∏–Ω—Å–∫–∏—è —Å—ä–≤–µ—Ç"
            ],
            en: [
                "Who is the mayor of Dimitrovgrad?",
                "Who is the chairman of the Municipal Council?",
                "Municipality working hours",
                "Contact phone number",
                "Cultural program",
                "Municipal Council session",
                "Municipality budget 2025",
                "Municipal Council decisions"
            ]
        };

        function loadFaqButtons() {
            faqButtonsContainer.innerHTML = "";
            faqData[currentLang].forEach(text => {
                const btn = document.createElement("button");
                btn.textContent = text;
                btn.addEventListener("click", () => sendQuery(text));
                faqButtonsContainer.appendChild(btn);
            });
        }

        function linkify(text) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.replace(urlRegex, url => `<a href="${url}" target="_blank">${url}</a>`);
        }

        function addMessage(text, sender, isHTML=false) {
            const div = document.createElement('div');
            div.classList.add('message', sender);
            div.innerHTML = isHTML ? text : linkify(text);
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;

            if (sender === "bot") lastBotReply = text;
        }

        function showGreeting() {
            if (currentLang === "bg") {
                addMessage("üëã –ó–¥—Ä–∞–≤–µ–π! –ê–∑ —Å—ä–º —á–∞—Ç–±–æ—Ç—ä—Ç –∑–∞ –û–±—â–∏–Ω–∞ –î–∏–º–∏—Ç—Ä–æ–≤–≥—Ä–∞–¥. –ü–æ–ø–∏—Ç–∞–π –º–µ –Ω–µ—â–æ –∏–ª–∏ –∏–∑–ø–æ–ª–∑–≤–∞–π –±—É—Ç–æ–Ω–∏—Ç–µ –ø–æ-–¥–æ–ª—É.", "bot", true);
                typing.textContent = "–ë–æ—Ç—ä—Ç –ø–∏—à–µ...";
                input.placeholder = "–í—ä–≤–µ–¥–µ—Ç–µ –≤—ä–ø—Ä–æ—Å...";
                document.getElementById("sendBtn").textContent = "–ò–∑–ø—Ä–∞—Ç–∏";
            } else {
                addMessage("üëã Hello! I am the Dimitrovgrad Municipality chatbot. Ask me something or use the buttons below.", "bot", true);
                typing.textContent = "Bot is typing...";
                input.placeholder = "Type your question...";
                document.getElementById("sendBtn").textContent = "Send";
            }
        }

        async function sendQuery(query) {
            addMessage(query, "user");
            typing.style.display = "block";
            form.querySelector("button[type=submit]").disabled = true;

            try {
                const response = await fetch("/search", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({query, lang: currentLang})
                });
                const data = await response.json();
                typing.style.display = "none";
                form.querySelector("button[type=submit]").disabled = false;

                if (data.error) {
                    addMessage("‚ö†Ô∏è " + (currentLang === "bg" ? "–í—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞: " : "Error: ") + data.error, "bot");
                } else {
                    data.forEach(item => addMessage(item.snippet, "bot", true));
                }
            } catch (err) {
                typing.style.display = "none";
                form.querySelector("button[type=submit]").disabled = false;
                addMessage("‚ö†Ô∏è " + (currentLang === "bg" ? "–ü—Ä–æ–±–ª–µ–º —Å –≤—Ä—ä–∑–∫–∞—Ç–∞: " : "Connection error: ") + err.message, "bot");
            }
        }

        form.addEventListener("submit", e => {
            e.preventDefault();
            const text = input.value.trim();
            if (text) {
                sendQuery(text);
                input.value = "";
            }
        });

        // üé§ –ì–ª–∞—Å–æ–≤–æ –≤—ä–≤–µ–∂–¥–∞–Ω–µ
        let recognition;
        if ("webkitSpeechRecognition" in window) {
            recognition = new webkitSpeechRecognition();
            recognition.lang = "bg-BG";
            recognition.continuous = false;
            recognition.interimResults = false;

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                input.value = transcript;
                sendQuery(transcript);
            };
        }

        micBtn.addEventListener("click", () => {
            if (recognition) {
                recognition.lang = currentLang === "bg" ? "bg-BG" : "en-US";
                recognition.start();
            } else {
                alert(currentLang === "bg" ? "–í–∞—à–∏—è—Ç –±—Ä–∞—É–∑—ä—Ä –Ω–µ –ø–æ–¥–¥—ä—Ä–∂–∞ –≥–ª–∞—Å–æ–≤–æ –≤—ä–≤–µ–∂–¥–∞–Ω–µ." : "Your browser does not support voice input.");
            }
        });

        // üîä –ß–µ—Ç–µ–Ω–µ –Ω–∞ –æ—Ç–≥–æ–≤–æ—Ä
        speakBtn.addEventListener("click", () => {
            if (lastBotReply) {
                const utterance = new SpeechSynthesisUtterance(lastBotReply);
                utterance.lang = currentLang === "bg" ? "bg-BG" : "en-US";
                speechSynthesis.speak(utterance);
            } else {
                alert(currentLang === "bg" ? "–ù—è–º–∞ –æ—Ç–≥–æ–≤–æ—Ä –∑–∞ –ø—Ä–æ—á–∏—Ç–∞–Ω–µ." : "No reply to read.");
            }
        });

        // üåê –ü—Ä–µ–≤–∫–ª—é—á–≤–∞–Ω–µ –Ω–∞ –µ–∑–∏–∫–∞
        langToggle.addEventListener("click", () => {
            currentLang = currentLang === "bg" ? "en" : "bg";
            langToggle.textContent = currentLang === "bg" ? "EN" : "BG";
            loadFaqButtons();
            showGreeting();
        });

        // —Å—Ç–∞—Ä—Ç–∏—Ä–∞–º–µ —Å –±—ä–ª–≥–∞—Ä—Å–∫–∏
        loadFaqButtons();
        showGreeting();
    </script>
</body>
</html>
